<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Evolução de Peso — Shih Tzu</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --card:#071428;
      --glass: rgba(255,255,255,0.03);
      --muted:#9fb4c9;
      --accent:#7dd3fc;
      --accent-2:#60a5fa;
      --success:#9be7b5;
      --danger:#ffb4b4;
      color-scheme: dark;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(circle at top, #0d1a33, #050b18);
      color:#e6f0fb;
      -webkit-font-smoothing: antialiased;
    }

    /* layout core */
    .container{
      max-width:1100px;
      margin:28px auto;
      padding:18px;
      animation: fadeIn 0.7s ease;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    header{
      display:flex; 
      gap:12px; 
      align-items:center; 
      justify-content:space-between;
      padding-bottom:14px;
    }
    header h1{font-size:22px; margin:0}
    .sub{color:var(--muted); font-size:13px}

    .layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:16px;
      margin-top:18px;
    }
    @media(max-width:980px){
      .layout{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-radius:14px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.5);
      backdrop-filter: blur(6px);
      transition: transform .2s;
    }
    .card:hover{transform: translateY(-3px)}

    .btn{
      padding:8px 12px; 
      border-radius:10px; 
      border:0; 
      cursor:pointer; 
      font-weight:600;
      transition: opacity .2s, transform .2s;
    }
    .btn:hover{opacity:.8; transform: scale(.97)}
    .btn-prim{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#012233}
    .btn-ghost{
      background:transparent; 
      border:1px solid rgba(255,255,255,0.06); 
      color:var(--muted)
    }

    .small{font-size:13px; color:var(--muted)}
    table{width:100%; border-collapse:collapse; margin-top:12px; font-size:14px}
    th,td{padding:10px 8px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.05)}
    th{color:var(--muted); font-weight:600; font-size:13px}
    .editable{background:transparent; border:0; color:var(--accent); cursor:pointer; font-size:13px}
    .danger{color:var(--danger)}

    /* inputs */
    input, select{
      padding:10px 12px;
      border-radius:10px; 
      border:1px solid rgba(255,255,255,0.05); 
      background:var(--glass);
      color:inherit; 
      width:100%;
      font-size:14px;
    }

    footer{
      margin-top:22px;
      font-size:12px; 
      color:var(--muted);
      text-align:center;
      padding:20px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>Evolução de Peso — Shih Tzu</h1>
        <div class="sub">Acompanhe o crescimento real do filhote, atualizado diariamente.</div>
      </div>

      <div class="controls">
        <div class="small pill">Última leitura: <span id="last-read">—</span></div>
        <button id="exportCsv" class="btn btn-ghost">Exportar CSV</button>
      </div>
    </header>

    <div class="layout">

      <!-- LEFT -->
      <div>
        <div class="card">
          <strong>Gráfico de Crescimento</strong>
          <div class="small">Peso real + linha de tendência</div>

          <div style="height:320px; margin-top:12px;">
            <canvas id="chart"></canvas>
          </div>

          <div style="display:flex; gap:8px; margin-top:12px;">
            <button id="toggleTrend" class="btn btn-ghost">Tendência</button>
            <button id="clearView" class="btn btn-ghost">Limpar</button>
            <div style="flex:1"></div>
            <div class="small">Registros: <span id="count">0</span></div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <strong>Tabela — Dados reais</strong>
          <div class="small">Mais recente primeiro</div>

          <div style="overflow:auto; max-height:360px; margin-top:12px;">
            <table>
              <thead>
                <tr><th>Data</th><th>Dias</th><th>Peso (kg)</th><th>Ações</th></tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right">
        <div class="card">
          <strong>Adicionar / Atualizar Peso</strong>

          <form id="form">
            <div class="row" style="margin-top:10px">
              <label style="width:90px">Data</label>
              <input id="date" type="date" required>
            </div>

            <div class="row" style="margin-top:10px">
              <label style="width:90px">Peso</label>
              <input id="weight" type="number" step="0.001" required placeholder="ex: 1.820">
            </div>

            <div class="row" style="margin-top:10px">
              <label style="width:90px">Dias</label>
              <input id="day" type="number" placeholder="opcional">
            </div>

            <div style="margin-top:12px; display:flex; gap:10px;">
              <button class="btn btn-prim" type="submit">Salvar</button>
              <button type="button" id="btnSample" class="btn btn-ghost">Exemplo</button>
            </div>
          </form>
        </div>

        <div class="card small">
          <strong>Deploy</strong>
          <ol>
            <li>Faça upload no GitHub (branch main).</li>
            <li>Ative GitHub Pages → "/root".</li>
            <li>Pronto: link público disponível.</li>
          </ol>
        </div>
      </div>
    </div>

    <footer>
      Criado para acompanhar o crescimento real do filhote, dia a dia.
    </footer>
  </div>

  <!-- Firebase -->
  <script type="module">
    /* ==== SEU FIREBASE CONFIG (mantido exatamente como enviou) ==== */
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDgC8CLVszMnwZzvu1FF0-hmHH2K7G1BgQ",
      authDomain: "shihtzu-7533b.firebaseapp.com",
      projectId: "shihtzu-7533b",
      storageBucket: "shihtzu-7533b.firebasestorage.app",
      messagingSenderId: "188564051994",
      appId: "1:188564051994:web:5a27ecb209c83e959fd9a3",
      measurementId: "G-R8MYC7KZDL"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const app = initializeApp(FIREBASE_CONFIG);
    const db = getDatabase(app);
    const basePath = "weights";

    /* DOM references */
    const tbody = document.getElementById("tbody");
    const lastRead = document.getElementById("last-read");
    const countEl = document.getElementById("count");
    const form = document.getElementById("form");
    const dateInput = document.getElementById("date");
    const weightInput = document.getElementById("weight");
    const dayInput = document.getElementById("day");
    const btnSample = document.getElementById("btnSample");
    const exportBtn = document.getElementById("exportCsv");
    const toggleTrend = document.getElementById("toggleTrend");
    const clearView = document.getElementById("clearView");

    /* Chart */
    const ctx = document.getElementById("chart").getContext("2d");
    let showTrend = true;

    let chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Peso (kg)",
            data: [],
            borderWidth:2,
            tension:0.3,
            pointRadius:4,
            backgroundColor:"rgba(125,211,252,0.08)",
            borderColor:"#7dd3fc",
            fill:true
          },
          {
            label:"Tendência",
            data:[],
            borderDash:[6,4],
            borderWidth:1.5,
            pointRadius:0,
            borderColor:"#ffd87a",
            fill:false,
            hidden:!showTrend
          }
        ]
      },
      options:{
        responsive:true,
        plugins:{legend:{labels:{color:"#cfeeff"}}},
        scales:{
          x:{ticks:{color:"#cfeeff"}},
          y:{ticks:{color:"#cfeeff"}}
        }
      }
    });

    /* Helpers */
    function isoToDisplay(iso){
      const p = iso.split("-");
      return `${p[2]}/${p[1]}/${p[0]}`;
    }

    function todayIso(){
      return new Date().toISOString().slice(0,10);
    }

    /* Realtime listener */
    onValue(ref(db, basePath), snap => {
      const data = snap.val() || {};
      const arr = Object.values(data).map(v => v)
        .sort((a,b)=> a.date < b.date ? 1 : -1);

      renderTable(arr);
      renderChart(arr);

      lastRead.textContent = new Date().toLocaleString();
      countEl.textContent = arr.length;
    });

    /* Render table */
    function renderTable(arr){
      tbody.innerHTML = "";
      if(arr.length===0){
        tbody.innerHTML = "<tr><td colspan='4' class='small'>Sem dados ainda</td></tr>";
        return;
      }

      for(const r of arr){
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${isoToDisplay(r.date)}</td>
          <td>${r.day ?? "-"}</td>
          <td>${r.weight.toFixed(3)}</td>
          <td>
            <button class="editable">Editar</button>
            <button class="editable danger" style="margin-left:8px">Excluir</button>
          </td>
        `;

        tr.querySelector(".editable").onclick = () => {
          dateInput.value = r.date;
          weightInput.value = r.weight;
          dayInput.value = r.day ?? "";
          window.scrollTo({top:0, behavior:"smooth"});
        };

        tr.querySelector(".danger").onclick = () => {
          if(confirm("Excluir entrada de " + isoToDisplay(r.date) + "?")){
            remove(ref(db, `${basePath}/${r.date}`));
          }
        };

        tbody.appendChild(tr);
      }
    }

    /* Render chart */
    function renderChart(arr){
      const sorted = [...arr].sort((a,b)=> a.date < b.date ? -1 : 1);
      const labels = sorted.map(x => isoToDisplay(x.date));
      const data = sorted.map(x => Number(x.weight));

      chart.data.labels = labels;
      chart.data.datasets[0].data = data;

      if(sorted.length >= 2){
        const xs = data.map((_,i)=>i);
        const ys = data;
        const n = xs.length;

        const sumX = xs.reduce((a,b)=>a+b,0);
        const sumY = ys.reduce((a,b)=>a+b,0);
        const sumXY = xs.reduce((a,b,i)=>a + b*ys[i],0);
        const sumXX = xs.reduce((a,b)=>a + b*b,0);

        const denom = n*sumXX - sumX*sumX;
        const m = (n*sumXY - sumX*sumY) / denom;
        const c = (sumY - m*sumX) / n;

        const trend = xs.map(x => m*x + c);
        chart.data.datasets[1].data = trend;
        chart.data.datasets[1].hidden = !showTrend;
      }

      chart.update();
    }

    /* Form submit */
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const date = dateInput.value;
      const weight = Number(weightInput.value);
      const day = dayInput.value ? Number(dayInput.value) : null;

      await set(ref(db, `${basePath}/${date}`), {
        date,
        weight,
        day,
        ts: Date.now()
      });

      weightInput.value = "";
      dayInput.value = "";
    });

    btnSample.onclick = () => {
      dateInput.value = todayIso();
      weightInput.value = (1.2 + Math.random()*0.9).toFixed(3);
    };

    exportBtn.onclick = () => {
      const rows = Array.from(tbody.querySelectorAll("tr"))
        .map(tr => Array.from(tr.querySelectorAll("td")).map(td => td.textContent.trim()))
        .filter(r => r.length >= 3);

      if(rows.length === 0) return alert("Sem dados.");

      const csv = ["Data;Dias;Peso_kg", ...rows.map(r => r.join(";"))].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "shihtzu_peso.csv";
      a.click();
      URL.revokeObjectURL(url);
    };

    toggleTrend.onclick = () => {
      showTrend = !showTrend;
      chart.data.datasets[1].hidden = !showTrend;
      chart.update();
    };

    clearView.onclick = () => {
      chart.data.labels = [];
      chart.data.datasets.forEach(d => d.data = []);
      chart.update();
    };

    dateInput.value = todayIso();
  </script>
</body>
</html>
